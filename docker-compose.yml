version: "3.8"

services:
  python-server:
    build:
      context: ./python-server
    ports:
      - "8000:8000"

  node-server:
    build:
      context: ./anythink-express-server
    ports:
      - "8001:8001"
    volumes:
      - ./anythink-express-server:/app
    command: yarn start
    # We use a Node script for the check because 'curl' isn't in the image
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8001', (res) => res.statusCode === 200 ? process.exit(0) : process.exit(1))"]
      interval: 3s
      timeout: 2s
      retries: 10
      start_period: 5s # Gives yarn start time to breathe before checking